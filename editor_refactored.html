<!DOCTYPE html>
<html lang="en">
<head>
<title>ACE in Action</title>
<style type="text/css" media="screen">
    #editor {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    #quickcmd {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 25px;
    }

    #statusBar {
        margin: 0;
        padding: 0;
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 20px;

        z-index: 9999;
    }

    .gace-highlight {
        background-color: red;
        position: absolute;
    }
</style>
</head>
<body>

<div id="editor">
  ______          ______
 /      \        /      \
|  $$$$$$\      |  $$$$$$\ _______  ______
| $$ __\$$______| $$__| $$/       \/      \
| $$|    |      | $$    $|  $$$$$$|  $$$$$$\
| $$ \$$$$\$$$$$| $$$$$$$| $$     | $$    $$
| $$__| $$      | $$  | $| $$_____| $$$$$$$$
 \$$    $$      | $$  | $$\$$     \\$$     \
  \$$$$$$        \$$   \$$ \$$$$$$$ \$$$$$$$

Select a file or press Ctrl-n from the filetree to start hacking!
</div>
<div id="statusBar"></div>

<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="ace/ext-language_tools.js"></script>
<script src="ace/ext-settings_menu.js"></script>
<script src="ace/ext-keybinding_menu.js"></script>
<script src="ace/ext-statusbar.js"></script>
<script src="anim.min.js"></script>
<script src="base64/base64.min.js" type="text/javascript" charset="utf-8"></script>

<script>
    var editor = ace.edit("editor");

    // Load editor related classes etc
    var langTools = ace.require("ace/ext/language_tools");
    ace.require('ace/ext/settings_menu').init(editor);
    ace.require('ace/ext/keybinding_menu').init(editor);

    var StatusBar = ace.require('ace/ext/statusbar').StatusBar;
    var statusBar = new StatusBar(editor, document.getElementById("statusBar"));

    // We should remove the old class, but it gets overridden by the new one so meh
    editor.renderer.on("themeLoaded", function(e) {
        document.getElementById("statusBar").classList.add(editor.renderer.theme.cssClass);
    });

    var Search = ace.require("ace/search").Search;

    // Enable autocomplete etc
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true,
        scrollPastEnd: true,
        dragEnabled: false
    });

    // Add Gmod automcompletions
    var acutil = ace.require("ace/autocomplete/util");

    var gmodApiCallbacks = {};
    var requestId = 0;
    var gmodApiCompleter = {
        getCompletions: function(editor, session, pos, prefix, callback) {
            var ID_REGEX = /[a-zA-Z_0-9\$\-\u00A2-\uFFFF\.]/;
            var line = editor.session.getLine(pos.row);
            var codeprefix = acutil.retrievePrecedingIdentifier(line, pos.column, ID_REGEX);

            if (codeprefix.length === 0) { callback(null, []); return }

            if ("gace" in window) {
                var creqid = "request" + (requestId++);
                gmodApiCallbacks[creqid] = callback;
                gace.QueryGModApi(creqid, codeprefix);
            }
        }
    }
    langTools.addCompleter(gmodApiCompleter);

    function ParseGModQueryResponse(requestid, values) {
        gmodApiCallbacks[requestid](null, values);
        delete gmodApiCallbacks[requestid];
    }

    // Add row highlighting
    var AceRange = require("ace/range").Range;
    function HighlightRow(rownum) {
        var marker = editor.getSession().addMarker(new AceRange(rownum, 0, rownum, 2000), "gace-highlight", "fullLine");

        setTimeout(function() {
            anim(document.querySelector(".gace-highlight"), {opacity: 0}, 3, "ease-in");
        }, 100);

		setTimeout(function() {
			editor.getSession().removeMarker(marker);
		}, 3100);
    }

    var emptySessionContent = editor.getSession().getValue();
    var emptySession = ace.createEditSession(editor.getSession().getValue(), "ace/mode/rust");

    editor.setSession(emptySession);

    editor.on("change", function(e) {
        if ("gace" in window) {
            gace.UpdateSessionContent(editor.getSession().getValue());
        }
    });

    editor.commands.addCommand({
        name: 'Open documentation',
        bindKey: {win: 'Ctrl-Q',  mac: 'Command-Q'},
        exec: function(editor) {
            var pos = editor.getCursorPosition();

            var ID_REGEX = /[a-zA-Z_0-9\$\-\u00A2-\uFFFF\.]/;
            var line = editor.session.getLine(pos.row);
            var codeprefix = acutil.retrievePrecedingIdentifier(line, pos.column, ID_REGEX);
            var codepostfix = acutil.retrieveFollowingIdentifier(line, pos.column, ID_REGEX).join("");

            var codeLibCall = codeprefix + codepostfix;

            if ("gace" in window) {
                gace.OpenDocumentationFor(codeLibCall);
            }
        }
    });

    editor.commands.addCommand({
        name: 'Save',
        bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
        exec: function(editor) {
            gace.SaveSession();
        }
    });

    editor.commands.addCommand({
        name: 'New file',
        bindKey: {win: 'Ctrl-N',  mac: 'Command-N'},
        exec: function(editor) {
            gace.NewSession();
        },
        readOnly: true
    });

    editor.commands.addCommand({
        name: 'Close file',
        bindKey: {win: 'Ctrl-W',  mac: 'Command-W'},
        exec: function(editor) {
            gace.CloseSession(false);
        },
        readOnly: true
    });

    editor.commands.addCommand({
        name: 'Add next instance of word to selection',
        bindKey: {win: 'Ctrl-Alt-D',  mac: 'Command-Alt-D'},
        exec: function(editor) {
            var selectedText = editor.getSession().getTextRange(editor.getSelectionRange());
            var range = editor.find({
                needle: selectedText,
                start: editor.getSelectionRange(),
                preventScroll: true
            });
            editor.getSession().getSelection().addRange(range);
        },
        readOnly: true
    });

    editor.commands.addCommand({
        name: 'Go to link',
        bindKey: {win: 'Ctrl-enter',  mac: 'Ctrl-enter'},
        exec: function(editor) {
            var selectedText = editor.getSession().getLine(editor.getCursorPosition().row);
            var res = selectedText.match(/goto\[f=([^;]*);r=([^;\]]*)(?:;c=([^\]]*))?/);
            if (res && !isNaN(res[2]))
                gace.GotoPath(res[1], parseInt(res[2]), parseInt(res[3]));
            else if (!res)
                console.log("G-Ace Goto failed: line doesn't seem to be a 'goto' line");
            else
                console.log("G-Ace Goto failed: " + res[2] + " can't be converted to number");
        },
        readOnly: true
    });

    editor.commands.addCommand({
        name: "Outdent (workaround)",
        bindKey: {win: "Ctrl-Shift-Tab", max: "Ctrl-Shift-Tab"},
        exec: function(editor) { editor.blockOutdent(); },
        multiSelectAction: "forEach",
        scrollIntoView: "selectionPart"
    })

    // Weirdest hack EU. We need to throw an error in here, or typing right curly brackets won't work
    editor.commands.addCommand({
        name: 'Add right curly bracket }',
        bindKey: {win: 'Ctrl-alt-0', mac: 'Ctrl-alt-0'},
        exec: function(editor) {
            //return false;
            throw "dirty hack to make right curly bracket work";
        }
    });

    // whatever
    String.prototype.endsWith = function(suffix) {
        return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };

    function guessModeFromPath(path) {
        if (path.endsWith(".moon"))
            return "ace/mode/coffee";

        var mode = ace.require('ace/ext/modelist').getModeForPath(path);

        // We'll assume if ace couldnt figure out the mode, it's Lua
        if (mode.name != "text") {
            return mode.mode;
        }
        return "ace/mode/lua";
    }

    var gaceSessions = (function() {
        var sessions = {};
        var sessionId = null;

        return {
            exists: function(id) {
                return id in sessions;
            },
            setSession: function(id, data) {
                var existedBefore = true;

                if (!this.exists(id)) {
                    var mode = (data.mode === undefined ? guessModeFromPath(id) : data.mode);
                    sessions[id] = ace.createEditSession("", mode);
                    existedBefore = false;
                }

                var session = sessions[id];

                session.setUseWrapMode(false);
                session.setUseSoftTabs(false);

                editor.setSession(session);
                editor.setReadOnly(false);
                sessionId = id;

                var content;
                if ("contentb" in data)
                    content = Base64.decode(data.contentb);
                else
                    content = data.content;

                if (content !== undefined)
                    session.setValue(content);
                else if (data.requestDataIfNotCached && !existedBefore)
                    // If we're setting session without passing contents and contents are not cached in html, request newest content from lua
                    gace.RequestSessionContent();
            },
            removeSession: function(id) {
                // If closed session is current session, lets clear it by making new empty session
                if (editor.getSession() == sessions[id]) {
                    editor.setSession(emptySession);
                    editor.setReadOnly(true);
                    sessionId = null;
                }
                delete sessions[id];
            },
            getSessionId: function() {
                return sessionId;
            }
        }
    })();

    // Ugly hack, required because theme id isn't passed to themeLoaded
    var changingToTheme;
    editor.renderer.on("themeChange", function(e) {
        changingToTheme = e.theme;
    });
    editor.renderer.on("themeLoaded", function(e) {
        var editorStyle = getComputedStyle(document.querySelector(".ace_editor"));
        var gutterStyle = getComputedStyle(document.querySelector(".ace_gutter"));

        var bgColor = editorStyle.backgroundColor.match(/\d+/g).slice(0,3);
        var fgColor = editorStyle.color.match(/\d+/g).slice(0,3);

        var gutterBgColor = gutterStyle.backgroundColor.match(/\d+/g).slice(0,3);

        if ("gace" in window) {
            gace.ThemeChanged(changingToTheme, bgColor.join(":"), fgColor.join(":"), gutterBgColor.join(":"));
        }
    });

    editor.on("changeMode", function(e) {
        if ("gace" in window)
            gace.ModeChanged(editor.getSession().getMode().$id);
    });

    function OnReady() {
        if ("gace" in window)
            gace.EditorReady();
    }
    document.addEventListener('DOMContentLoaded', OnReady);

    document.getElementById('editor').style.fontSize = '14px';
</script>
</body>
</html>
