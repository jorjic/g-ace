<!DOCTYPE html>
<html lang="en">
<head>
<title>ACE in Action</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    #quickcmd {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 25px;
    }
</style>
</head>
<body>

<div id="editor"></div>
    
<script src="ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="ace/ext-language_tools.js"></script>
<script src="base64.min.js" type="text/javascript" charset="utf-8"></script>
<script>
    // Load autocomplete extension
    ace.require("ace/ext/language_tools");

    var Search = ace.require("ace/search").Search;

    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/tomorrow_night");
    editor.getSession().setMode("ace/mode/glua");

    // Enable autocomplete etc
    editor.setOptions({
        enableBasicAutocompletion: true,
        enableSnippets: true
    });

    editor.on("change", function(e) {
        if ("gace" in window) {
            gace.SetEditedNotSaved(true);
            gace.ReportLatestContent(editor.getSession().getValue());
        }
    });

    editor.commands.addCommand({
        name: 'Save',
        bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
        exec: function(editor) {
            gace.SaveSession(editor.getSession().getValue());
        },
        readOnly: true // false if this command should not apply in readOnly mode
    });
    editor.commands.addCommand({
        name: 'Add next instance of word to selection',
        bindKey: {win: 'Ctrl-Alt-D',  mac: 'Command-Alt-D'},
        exec: function(editor) {
            var selectedText = editor.getSession().getTextRange(editor.getSelectionRange());
            var range = editor.find({
                needle: selectedText,
                start: editor.getSelectionRange(),
                preventScroll: true
            });
            editor.getSession().getSelection().addRange(range);
        },
        readOnly: true // false if this command should not apply in readOnly mode
    });

    editor.commands.addCommand({
        name: 'Run on Self',
        bindKey: {win: 'F5',  mac: 'F5'},
        exec: function(editor) {
            gace.CallLDFunc("RunOnSelf", editor.getSession().getValue());
        },
    }); 
    editor.commands.addCommand({
        name: 'Run on Server',
        bindKey: {win: 'F6',  mac: 'F6'},
        exec: function(editor) {
            gace.CallLDFunc("RunOnServer", editor.getSession().getValue());
        },
    }); 
    editor.commands.addCommand({
        name: 'Run on Shared',
        bindKey: {win: 'F7',  mac: 'F7'},
        exec: function(editor) {
            gace.CallLDFunc("RunOnShared", editor.getSession().getValue());
        },
    }); 

    var gaceSessions = (function() {
        var sessions = {};

        return {
            exists: function(id) {
                return id in sessions;
            },
            reopen: function(id) {
                if (this.exists(id)) {
                    editor.setSession(sessions[id]);
                    gace.SetOpenedSession(id);
                    editor.setReadOnly(false);
                    return true;
                }
                return false;
            },
            open: function(id, data) {
                if (this.reopen(id))
                    return;

                var content;
                if ("contentb" in data)
                    content = Base64.decode(data.contentb);
                else
                    content = data.content;

                sessions[id] = ace.createEditSession(content, "ace/mode/glua");
                
                this.reopen(id);
                gace.SetEditedNotSaved(data.defens || false);
            },
            refresh: function(id, data) {
                this.open(id, data);

                var content;
                if ("contentb" in data)
                    content = Base64.decode(data.contentb);
                else
                    content = data.content;

                sessions[id].setValue(content);
                gace.SetEditedNotSaved(data.defens || false)
            },
            close: function(id) {
                // If closed session is current session, lets clear it by making new empty session
                if (editor.getSession() == sessions[id]) {
                    editor.setSession(ace.createEditSession("", "ace/mode/lua"));
                    editor.setReadOnly(true);
                }
                delete sessions[id];
            }
        }
    })();
</script>
</body>
</html>